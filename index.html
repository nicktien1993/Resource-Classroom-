
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>è³‡æºç­æ•¸å­¸æ•™å®¤ - è€å¸«çš„ AI æ•™ç ”åŠ©ç†</title>
    <!-- å¼•å…¥ Tailwind CSS å·¥å…· -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ PDF å°å‡ºå·¥å…· -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- é—œéµï¼šå¼•å…¥ Babel ç¿»è­¯å®˜ï¼Œè®“ç€è¦½å™¨çœ‹æ‡‚ React ä»£ç¢¼ -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .no-print { display: block; }
        @media print { 
            .no-print { display: none !important; }
            body { background: white; }
            .print-area { box-shadow: none !important; border: none !important; width: 100% !important; margin: 0 !important; padding: 0 !important; }
            .page-break { page-break-before: always; }
        }
        .canvas-container { border: 2px dashed #cbd5e1; border-radius: 1rem; background: #fff; touch-action: none; }
        .math-text { line-height: 2.5; font-size: 1.5rem; font-weight: 700; }
        .visual-aid svg { max-width: 100%; height: auto; margin: 1rem 0; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- è¨­å®šæ¨¡çµ„è·¯å¾‘ -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom": "https://esm.sh/react-dom@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "@google/genai": "https://esm.sh/@google/genai@1.34.0",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>

    <!-- æ³¨æ„ï¼šé€™è£¡çš„ type è®Šæˆäº† text/babelï¼Œä¸¦åŠ å…¥ data-type="module" -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import ReactDOM from 'react-dom/client';
        import { GoogleGenAI, Type } from '@google/genai';

        const SYSTEM_PROMPT = `ä½ æ˜¯ä¸€ä½è³‡æ·±åœ‹å°è³‡æºç­ç‰¹æ•™è€å¸«ã€‚
        1. è¬›ç¾© (Handout)ï¼šæ‹†è§£æ­¥é©Ÿï¼Œæä¾›ä¾‹é¡Œã€‚
        2. ç·´ç¿’å· (Homework)ï¼šåƒ…é™é¡Œç›®èˆ‡æç¤ºã€‚
        3. å¿…é ˆä½¿ç”¨ SVG åœ–ç¤ºè¼”åŠ©ã€‚
        4. ç¦æ­¢ä½¿ç”¨ $ ç¬¦è™Ÿã€‚ç›´æ¥å¯«ç´”æ–‡å­—ã€‚
        å›å‚³æ ¼å¼ï¼šç´” JSON ç‰©ä»¶ã€‚`;

        const DrawingCanvas = ({ id }) => {
            const canvasRef = useRef(null);
            const [isDrawing, setIsDrawing] = useState(false);
            const [tool, setTool] = useState('pen');

            useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                const resize = () => {
                    const rect = canvas.parentNode.getBoundingClientRect();
                    canvas.width = rect.width;
                    canvas.height = 300;
                    ctx.lineCap = 'round'; ctx.lineWidth = 3;
                };
                resize();
                window.addEventListener('resize', resize);
                return () => window.removeEventListener('resize', resize);
            }, []);

            const startDrawing = (e) => { setIsDrawing(true); draw(e); };
            const stopDrawing = () => { setIsDrawing(false); canvasRef.current.getContext('2d').beginPath(); };
            const draw = (e) => {
                if (!isDrawing) return;
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX || (e.touches && e.touches[0].clientX)) - rect.left;
                const y = (e.clientY || (e.touches && e.touches[0].clientY)) - rect.top;
                ctx.strokeStyle = tool === 'eraser' ? '#ffffff' : '#3b82f6';
                ctx.lineWidth = tool === 'eraser' ? 30 : 3;
                ctx.lineTo(x, y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x, y);
            };

            return (
                <div className="canvas-container no-print mb-6 overflow-hidden">
                    <div className="flex gap-2 p-2 bg-slate-50 border-b">
                        <button onClick={() => setTool('pen')} className={`px-3 py-1 rounded text-xs font-bold ${tool === 'pen' ? 'bg-blue-600 text-white' : 'bg-white border'}`}>ğŸ–Šï¸ ç•«ç­†</button>
                        <button onClick={() => setTool('eraser')} className={`px-3 py-1 rounded text-xs font-bold ${tool === 'eraser' ? 'bg-rose-500 text-white' : 'bg-white border'}`}>ğŸ§½ æ“¦é™¤</button>
                        <button onClick={() => { const ctx = canvasRef.current.getContext('2d'); ctx.clearRect(0, 0, canvasRef.current.width, canvasRef.current.height); }} className="px-3 py-1 rounded text-xs font-bold bg-white border">ğŸ—‘ï¸ æ¸…ç©º</button>
                    </div>
                    <canvas ref={canvasRef} onMouseDown={startDrawing} onMouseMove={draw} onMouseUp={stopDrawing} onTouchStart={startDrawing} onTouchMove={draw} onTouchEnd={stopDrawing} className="w-full cursor-crosshair bg-white" />
                </div>
            );
        };

        const App = () => {
            const [loading, setLoading] = useState(false);
            const [view, setView] = useState('welcome');
            const [hasKey, setHasKey] = useState(true);
            const [params, setParams] = useState({ publisher: 'åº·è»’', grade: 'å››å¹´ç´š', semester: 'ä¸Š' });
            const [chapters, setChapters] = useState([]);
            const [content, setContent] = useState(null);
            const [homework, setHomework] = useState(null);

            useEffect(() => {
                const checkKey = async () => { if (window.aistudio) setHasKey(await window.aistudio.hasSelectedApiKey()); };
                checkKey();
            }, []);

            const callAi = async (prompt) => {
                const apiKey = window.process?.env?.API_KEY || "";
                const ai = new GoogleGenAI({ apiKey });
                const response = await ai.models.generateContent({
                    model: 'gemini-3-flash-preview',
                    contents: prompt,
                    config: { systemInstruction: SYSTEM_PROMPT, responseMimeType: "application/json" }
                });
                return JSON.parse(response.text.replace(/```json/g, '').replace(/```/g, '').trim());
            };

            const handleFetchChapters = async () => {
                setLoading(true);
                try { setChapters(await callAi(`è«‹åˆ—å‡º ${params.publisher}ç‰ˆ åœ‹å°æ•¸å­¸ ${params.grade}${params.semester} çš„èª²ç¨‹å–®å…ƒç›®éŒ„ã€‚`)); } 
                catch (e) { alert("æŸ¥è©¢å¤±æ•—"); }
                setLoading(false);
            };

            const handleGenerateHandout = async (title, sub) => {
                setLoading(true);
                try { setContent(await callAi(`é‡å°ã€Œ${title}-${sub}ã€ç”Ÿæˆçµ¦è³‡æºç­å­¸ç”Ÿçš„è¬›ç¾©ã€‚`)); setView('handout'); } 
                catch (e) { alert("ç”Ÿæˆå¤±æ•—"); }
                setLoading(false);
            };

            return (
                <div className="min-h-screen flex flex-col md:flex-row">
                    <aside className="w-full md:w-80 bg-white border-r no-print p-6 space-y-8 overflow-y-auto max-h-screen sticky top-0">
                        <h1 className="text-2xl font-black text-slate-900">ğŸ è³‡æºç­æ•¸å­¸</h1>
                        {!hasKey && <button onClick={() => window.aistudio.openSelectKey()} className="w-full bg-rose-500 text-white py-2 rounded-lg font-bold text-sm">ğŸ”‘ é€£æ¥ API</button>}
                        <div className="space-y-4">
                            <select className="w-full p-2 border rounded-lg bg-slate-50 font-bold" value={params.publisher} onChange={e => setParams({...params, publisher: e.target.value})}><option>åº·è»’</option><option>å—ä¸€</option><option>ç¿°æ—</option></select>
                            <select className="w-full p-2 border rounded-lg bg-slate-50 font-bold" value={params.grade} onChange={e => setParams({...params, grade: e.target.value})}><option>ä¸€å¹´ç´š</option><option>äºŒå¹´ç´š</option><option>ä¸‰å¹´ç´š</option><option>å››å¹´ç´š</option><option>äº”å¹´ç´š</option><option>å…­å¹´ç´š</option></select>
                            <button onClick={handleFetchChapters} className="w-full bg-slate-800 text-white py-3 rounded-xl font-bold">æŸ¥è©¢ç›®éŒ„</button>
                        </div>
                        {chapters.length > 0 && (
                            <div className="space-y-4 max-h-[400px] overflow-y-auto pr-2">
                                {chapters.map((c, i) => (
                                    <div key={i} className="mb-4">
                                        <p className="text-xs font-black text-slate-400 border-b mb-2">{c.title}</p>
                                        {c.subChapters?.map((s, si) => <button key={si} onClick={() => handleGenerateHandout(c.title, s)} className="w-full text-left text-sm p-2 hover:bg-blue-50 rounded transition font-bold">ğŸ“„ {s}</button>)}
                                    </div>
                                ))}
                            </div>
                        )}
                    </aside>

                    <main className="flex-1 bg-slate-50 p-4 md:p-12 overflow-y-auto">
                        {loading ? <div className="flex flex-col items-center justify-center h-96 animate-pulse text-xl font-black text-slate-400">æ­£åœ¨å¬å–šæ•¸å­¸çŸ¥è­˜...</div> : (
                            view === 'welcome' ? <div className="text-center opacity-40 py-40"><div className="text-[120px]">ğŸ«</div><h2 className="text-3xl font-black">æ­¡è¿ä½¿ç”¨ AI æ•™å®¤</h2></div> :
                            view === 'handout' && content && (
                                <div className="max-w-4xl mx-auto space-y-8 bg-white p-10 rounded-[3rem] shadow-xl border border-slate-200">
                                    <div className="flex justify-between items-center no-print mb-8">
                                        <button onClick={() => setView('welcome')} className="text-slate-400 font-bold">â† è¿”å›</button>
                                        <button onClick={() => window.print()} className="bg-slate-800 text-white px-6 py-2 rounded-xl font-bold">ğŸ–¨ï¸ åˆ—å°è¬›ç¾©</button>
                                    </div>
                                    <h1 className="text-5xl font-black mb-8 border-l-8 border-blue-600 pl-6">{content.title}</h1>
                                    <div className="bg-blue-50 p-8 rounded-3xl border-2 border-blue-100 mb-12"><p className="math-text text-slate-700">{content.concept}</p></div>
                                    {content.examples?.map((ex, i) => (
                                        <div key={i} className="relative mb-20 border-t pt-10">
                                            <span className="bg-blue-600 text-white px-4 py-1 rounded-lg text-xs font-bold mb-4 inline-block">ä¾‹é¡Œ {i+1}</span>
                                            <p className="text-3xl font-black mb-6">{ex.question}</p>
                                            {ex.visualAidSvg && <div dangerouslySetInnerHTML={{__html: ex.visualAidSvg}} />}
                                            <DrawingCanvas id={`ex-${i}`} />
                                            <div className="bg-slate-50 p-6 rounded-2xl">{ex.stepByStep?.map((s, si) => <p key={si} className="text-slate-500 font-bold">Step {si+1}: {s}</p>)}<p className="text-2xl font-black text-emerald-600 pt-4 mt-4 border-t">ç­”ï¼š{ex.answer}</p></div>
                                        </div>
                                    ))}
                                </div>
                            )
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
