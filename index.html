
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>è³‡æºç­æ•¸å­¸æ•™å®¤ - AI è‡ªå‹•è¬›ç¾©ç”Ÿæˆå™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; color: #0f172a; }
        .visual-aid-container { margin: 2rem 0; padding: 2rem; background: #fff; border: 3px dashed #cbd5e1; border-radius: 2rem; display: flex; justify-content: center; }
        .example-block { background: #fff; border: 2px solid #e2e8f0; border-radius: 2rem; padding: 2rem; margin-bottom: 2rem; }
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom": "https://esm.sh/react-dom@18.2.0",
    "@google/genai": "https://esm.sh/@google/genai@1.34.0",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>

    <script type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import ReactDOM from 'react-dom';
        import { GoogleGenAI, Type } from '@google/genai';

        // --- AI æœå‹™é‚è¼¯ ---
        const SYSTEM_INSTRUCTION = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„åœ‹å°è³‡æºç­ç‰¹æ•™è€å¸«ã€‚
        1. è¬›ç¾©ï¼šé¡Œç›®èˆ‡æ­¥é©Ÿåˆ†é›¢ã€‚
        2. ç·´ç¿’å·ï¼šç´”é¡Œç›®ï¼Œå¯æä¾›æç¤ºã€‚
        3. å¿…é ˆä½¿ç”¨ SVG åœ–ç¤ºè¼”åŠ©ã€‚
        4. ç¦æ­¢ä½¿ç”¨ $ ç¬¦è™Ÿï¼Œç›´æ¥å¯«ç´”æ–‡å­—æ•¸å­¸å¼ã€‚
        æ ¼å¼è¦æ±‚ï¼šåƒ…å›å‚³ JSONã€‚`;

        const cleanJsonResponse = (text) => text?.replace(/```json/g, '').replace(/```/g, '').trim() || "{}";

        // --- React å…ƒä»¶ ---
        const App = () => {
            const [params, setParams] = useState({ year: '114', publisher: 'åº·è»’', grade: 'å››å¹´ç´š', semester: 'ä¸Š' });
            const [chapters, setChapters] = useState([]);
            const [handout, setHandout] = useState(null);
            const [loading, setLoading] = useState(false);
            const [hasKey, setHasKey] = useState(true);

            // æª¢æŸ¥ API KEY
            useEffect(() => {
                const checkKey = async () => {
                    if (!window.process?.env?.API_KEY && window.aistudio) {
                        const selected = await window.aistudio.hasSelectedApiKey();
                        setHasKey(selected);
                    }
                };
                checkKey();
            }, []);

            const handleSearch = async () => {
                setLoading(true);
                try {
                    const ai = new GoogleGenAI({ apiKey: window.process?.env?.API_KEY || "" });
                    const response = await ai.models.generateContent({
                        model: 'gemini-3-flash-preview',
                        contents: `è«‹åˆ—å‡º ${params.publisher}ç‰ˆ åœ‹å°æ•¸å­¸ ${params.grade}${params.semester} çš„å–®å…ƒç›®éŒ„ã€‚`,
                        config: {
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: Type.ARRAY,
                                items: {
                                    type: Type.OBJECT,
                                    properties: {
                                        title: { type: Type.STRING },
                                        subChapters: { type: Type.ARRAY, items: { type: Type.STRING } }
                                    }
                                }
                            }
                        }
                    });
                    setChapters(JSON.parse(cleanJsonResponse(response.text)));
                } catch (e) { alert("æœå°‹å¤±æ•—ï¼Œè«‹ç¢ºèª API é‡‘é‘°"); }
                setLoading(false);
            };

            const generateHandout = async (title, sub) => {
                setLoading(true);
                try {
                    const ai = new GoogleGenAI({ apiKey: window.process?.env?.API_KEY || "" });
                    const response = await ai.models.generateContent({
                        model: 'gemini-3-pro-preview',
                        contents: `é‡å°ã€Œ${title}-${sub}ã€ç”Ÿæˆè³‡æºç­æ•™å­¸è¬›ç¾©ã€‚`,
                        config: {
                            systemInstruction: SYSTEM_INSTRUCTION,
                            responseMimeType: "application/json"
                        }
                    });
                    setHandout(JSON.parse(cleanJsonResponse(response.text)));
                } catch (e) { alert("ç”Ÿæˆå¤±æ•—"); }
                setLoading(false);
            };

            return (
                <div className="p-4 max-w-5xl mx-auto">
                    <header className="flex justify-between items-center mb-8 no-print">
                        <h1 className="text-3xl font-black">ğŸ è³‡æºç­æ•¸å­¸æ•™å®¤</h1>
                        {!hasKey && (
                            <button onClick={() => window.aistudio.openSelectKey()} className="bg-rose-500 text-white px-4 py-2 rounded-full font-bold">ğŸ”‘ é€£æ¥ API</button>
                        )}
                    </header>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                        {/* å·¦å´æ¬„ï¼šè¨­å®šèˆ‡ç›®éŒ„ */}
                        <div className="space-y-6 no-print">
                            <div className="bg-white p-6 rounded-2xl shadow-sm border">
                                <h3 className="font-bold mb-4">1. é¸æ“‡ç‰ˆæœ¬</h3>
                                <select className="w-full mb-3 p-2 border rounded" onChange={e => setParams({...params, publisher: e.target.value})}>
                                    <option>åº·è»’</option><option>å—ä¸€</option><option>ç¿°æ—</option>
                                </select>
                                <select className="w-full mb-3 p-2 border rounded" onChange={e => setParams({...params, grade: e.target.value})}>
                                    <option>ä¸€å¹´ç´š</option><option>äºŒå¹´ç´š</option><option>ä¸‰å¹´ç´š</option><option>å››å¹´ç´š</option><option>äº”å¹´ç´š</option><option>å…­å¹´ç´š</option>
                                </select>
                                <button onClick={handleSearch} disabled={loading} className="w-full bg-slate-800 text-white py-2 rounded-xl font-bold">
                                    {loading ? 'æœå°‹ä¸­...' : 'æŸ¥è©¢ç›®éŒ„'}
                                </button>
                            </div>

                            {chapters.length > 0 && (
                                <div className="bg-white p-6 rounded-2xl shadow-sm border max-h-96 overflow-y-auto">
                                    <h3 className="font-bold mb-4">2. é¸æ“‡å–®å…ƒ</h3>
                                    {chapters.map((c, i) => (
                                        <div key={i} className="mb-4">
                                            <p className="font-bold text-sm text-slate-500 border-b pb-1 mb-2">{c.title}</p>
                                            {c.subChapters.map((s, si) => (
                                                <button key={si} onClick={() => generateHandout(c.title, s)} className="block w-full text-left text-xs p-2 hover:bg-slate-50 rounded">
                                                    {s}
                                                </button>
                                            ))}
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>

                        {/* å³å´æ¬„ï¼šå…§å®¹æª¢è¦– */}
                        <div className="md:col-span-2">
                            {loading && <div className="p-20 text-center font-bold animate-pulse text-slate-400">æ­£åœ¨è£½ä½œæ•™æ...</div>}
                            
                            {handout && (
                                <div className="bg-white p-10 rounded-3xl shadow-lg border border-slate-200">
                                    <div className="flex justify-between mb-8 no-print">
                                        <button onClick={() => window.print()} className="bg-slate-800 text-white px-4 py-2 rounded-lg font-bold">åˆ—å°è¬›ç¾©</button>
                                    </div>
                                    <h2 className="text-4xl font-black mb-6">{handout.title}</h2>
                                    <div className="text-xl leading-relaxed mb-8 bg-slate-50 p-6 rounded-2xl border-l-8 border-amber-500">
                                        {handout.concept}
                                    </div>
                                    
                                    <div className="space-y-12">
                                        {handout.examples?.map((ex, i) => (
                                            <div key={i} className="example-block">
                                                <span className="bg-blue-600 text-white px-4 py-1 rounded-lg text-xs font-bold mb-4 inline-block">ä¾‹é¡Œ {i+1}</span>
                                                <p className="text-2xl font-bold mb-6">{ex.question}</p>
                                                <div className="space-y-2 border-t pt-4">
                                                    {ex.stepByStep?.map((s, si) => (
                                                        <p key={si} className="text-slate-600">Step {si+1}: {s}</p>
                                                    ))}
                                                </div>
                                                <p className="mt-6 text-2xl font-black text-emerald-600">ç­”ï¼š{ex.answer}</p>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {!handout && !loading && (
                                <div className="h-full flex flex-col items-center justify-center text-slate-300 p-20 border-4 border-dashed rounded-3xl">
                                    <span className="text-6xl mb-4">ğŸ’</span>
                                    <p className="font-bold">è«‹å…ˆå¾å·¦å´é¸æ“‡å–®å…ƒé–‹å§‹ç”Ÿæˆ</p>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>
